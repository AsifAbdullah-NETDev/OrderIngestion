CREATE OR ALTER PROCEDURE SP_InsertOrderWithItems
(
    @RequestId UNIQUEIDENTIFIER,
    @OrderNumber NVARCHAR(50),
    @CustomerName NVARCHAR(200),
    @CustomerEmail NVARCHAR(200),
    @Items dbo.OrderItemType READONLY
)
AS
BEGIN
    SET NOCOUNT ON;

    BEGIN TRY
        SET @OrderId = NULL;
        SET @StatusCode = 0;
        SET @StatusMessage = N'Success';

        IF EXISTS (SELECT 1 FROM Orders WHERE RequestId = @RequestId)
        BEGIN
            SET @OrderId = (SELECT TOP 1 OrderId FROM Orders WHERE RequestId = @RequestId);
            SET @StatusCode = -1;
            SET @StatusMessage = N'Order with this RequestId already exists';
            RETURN;
        END

        DECLARE @CustomerId INT;

        SELECT @CustomerId = CustomerId FROM Customers WHERE Email = @CustomerEmail;

        IF @CustomerId IS NULL
        BEGIN
            INSERT INTO Customers (Name, Email)
            VALUES (@CustomerName, @CustomerEmail);

            SET @CustomerId = SCOPE_IDENTITY();
        END

        INSERT INTO Orders (RequestId, OrderNumber, CustomerId)
        VALUES (@RequestId, @OrderNumber, @CustomerId);

        SET @OrderId = SCOPE_IDENTITY();

        INSERT INTO OrderItems (OrderId, SKU, Quantity, Price)
        SELECT @OrderId, SKU, Quantity, Price FROM @Items;
    END TRY
    BEGIN CATCH
        SET @StatusCode = ERROR_NUMBER();
        SET @StatusMessage = ERROR_MESSAGE();
    END CATCH;
END
